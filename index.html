<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>åœŸä¹‹ç©©è¡Œï½œé›»æµæ€¥æ€¥æ£’</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Noto Sans TC"', 'sans-serif'],
            },
            colors: {
              wood: {
                50: '#fcfbf7',
                100: '#f5f0e6',
                200: '#ede0cc',
                300: '#e0ccad',
                400: '#d2b48c',
                500: '#b08d55',
                600: '#8f7042',
                700: '#735735',
                800: '#5c452d',
                900: '#453221',
              },
              metal: {
                light: '#e8e8e8',
                gold: '#d4af37',
                dark: '#4a4a4a',
              },
              nature: {
                light: '#e9f5e9',
                main: '#4caf50',
                dark: '#2e7d32',
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        font-family: 'Noto Sans TC', sans-serif;
        background-color: #fcfbf7;
        /* Allow vertical scrolling, prevent horizontal */
        overflow-x: hidden;
        overflow-y: auto;
        user-select: none;
        -webkit-user-select: none;
      }
      
      /* Specific class to lock touch actions within the game area */
      .game-touch-lock {
        touch-action: none;
      }

      .wood-texture {
        background-color: #fcfbf7;
        background-image: radial-gradient(#d4c5b8 0.5px, transparent 0.5px),
                          radial-gradient(#d4c5b8 0.5px, #fcfbf7 0.5px);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
      }
      .fade-in { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .hidden { display: none !important; }
      
      .spark-anim {
        animation: spark 0.2s linear infinite;
      }
      @keyframes spark {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
    </style>
</head>
<body class="wood-texture text-wood-900 min-h-screen tracking-wide relative">

    <!-- === START SCREEN === -->
    <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center p-4 fade-in">
        <div class="max-w-md w-full bg-white/90 backdrop-blur-sm p-8 rounded-2xl shadow-xl border-2 border-wood-300 text-center">
            <div class="mb-6"><span class="text-5xl">âš¡</span></div>
            <h1 class="text-3xl md:text-4xl font-black text-wood-900 mb-8 tracking-widest">
                åœŸä¹‹ç©©è¡Œï½œæ€¥æ€¥é›»æµæ£’
            </h1>

            <div class="bg-wood-50 p-6 rounded-xl border border-wood-200 text-left mb-8">
                <p class="text-wood-700 mb-4 font-bold tracking-wider text-lg">
                    è„¾ä¸»è‚Œè‚‰ï¼Œæ°£è¡€å……ç›ˆå‰‡å‹•ä½œéˆå·§
                </p>
                <p class="text-base text-wood-600 mb-6 leading-relaxed font-medium tracking-wide">
                    æ“æ§é‡‘å±¬ç’°ï¼Œä½¿å…¶ä¸è§¸ç¢°è»Œé“ï¼Œè€ƒé©—æ‚¨çš„æ‰‹éƒ¨ç©©å®šåº¦ã€‚
                </p>
                <h2 class="text-xl font-bold text-wood-800 mb-3 border-b border-wood-300 pb-2 flex items-center gap-2 tracking-wider">
                    <span>ğŸ“œ</span> éŠæˆ²è¦å‰‡
                </h2>
                <ul class="space-y-3 text-wood-800 leading-relaxed text-base font-medium tracking-wide">
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-nature-dark">â‘ </span>
                        <span>æ‹–æ›³ä¸‹æ–¹æ‰‹æŸ„ï¼Œæ§åˆ¶é‡‘å±¬ç’°æ²¿ç·šå‰é€²</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-nature-dark">â‘¡</span>
                        <span>é‡‘å±¬ç’°ä¸å¯è§¸ç¢°è»Œé“ï¼Œå¦å‰‡éŠæˆ²çµæŸ</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-nature-dark">â‘¢</span>
                        <span>é™æ™‚30ç§’ï¼Œä¾å‰é€²è·é›¢è¨ˆåˆ†</span>
                    </li>
                </ul>
            </div>

            <button id="btn-start-game" class="w-full font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-nature-dark hover:bg-green-800 text-white shadow-green-200 px-8 py-3 text-2xl tracking-widest">
                é–‹å§‹éŠæˆ²
            </button>
        </div>
    </div>

    <!-- === GAME SCREEN === -->
    <div id="game-screen" class="hidden min-h-screen flex-col">
        <!-- Top Bar -->
        <div class="fixed top-0 left-0 right-0 z-40 bg-white/95 backdrop-blur shadow-md border-b border-wood-200 h-16 px-4">
            <div class="max-w-6xl mx-auto h-full flex items-center justify-between">
                <!-- Timer -->
                <div class="flex items-center gap-2 w-1/3">
                    <div id="timer-display" class="font-mono text-3xl font-bold flex items-center gap-2 text-wood-900">
                        <span>â³</span>
                        <span id="timer-val">30</span>s
                    </div>
                </div>
                <!-- Title (Desktop) -->
                <div class="hidden md:block w-1/3 text-center text-wood-700 font-bold opacity-50 text-xl tracking-widest">
                    åœŸä¹‹ç©©è¡Œ
                </div>
                <!-- Buttons -->
                <div class="flex items-center justify-end gap-2 w-2/3 md:w-1/3">
                    <button id="btn-show-rules" class="font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 border-2 border-wood-600 text-wood-800 hover:bg-wood-100 px-3 py-1 text-base tracking-wide">
                        è¦å‰‡
                    </button>
                    <button id="btn-restart" class="font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-wood-600 hover:bg-wood-700 text-white px-3 py-1 text-base tracking-wide">
                        é‡ä¾†
                    </button>
                </div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="w-full flex-grow flex justify-center items-center pt-20 pb-4 relative overflow-hidden">
            <!-- Game Board -->
            <div class="relative w-full max-w-[350px] aspect-[350/500] border-4 border-wood-300 rounded-2xl bg-white shadow-inner mx-4 select-none game-touch-lock">
                <svg id="game-svg" viewBox="0 0 350 500" class="w-full h-full cursor-crosshair overflow-visible">
                    <!-- Definitions -->
                    <defs>
                        <!-- Complex "Buzz Wire" Path -->
                        <!-- Start Bottom (175, 480) -> End Top (175, 30) -->
                        <path id="track-path" d="M 175 480 C 120 480 50 460 30 400 L 30 320 C 30 280 100 300 130 260 S 220 220 260 260 S 320 220 320 180 L 320 120 C 320 60 200 80 175 30" />
                        
                        <!-- Glow filter for electricity effect (optional) -->
                        <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur stdDeviation="2" result="blur" />
                            <feComposite in="SourceGraphic" in2="blur" operator="over" />
                        </filter>
                    </defs>
                    
                    <!-- 1. The Wire (Visual) -->
                    <!-- Main metallic wire -->
                    <path d="M 175 480 C 120 480 50 460 30 400 L 30 320 C 30 280 100 300 130 260 S 220 220 260 260 S 320 220 320 180 L 320 120 C 320 60 200 80 175 30"
                          fill="none" stroke="#d2b48c" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" />
                    <!-- Highlight for metallic effect -->
                    <path d="M 175 480 C 120 480 50 460 30 400 L 30 320 C 30 280 100 300 130 260 S 220 220 260 260 S 320 220 320 180 L 320 120 C 320 60 200 80 175 30"
                          fill="none" stroke="#f5e6d3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />

                    <!-- Start Point -->
                    <circle cx="175" cy="480" r="8" fill="#8f7042" />
                    <!-- End Point -->
                    <circle cx="175" cy="30" r="8" fill="#4caf50" opacity="0.8" />

                    <!-- 2. The Player (Handle + Ring) -->
                    <!-- Uses a group to move both together -->
                    <g id="player-group" transform="translate(175, 480)">
                         <!-- Handle (Dark Grey Stick) -->
                         <!-- Offset to be below the ring so finger doesn't block view -->
                         <path d="M 0,14 L 0,60" stroke="#4a4a4a" stroke-width="6" stroke-linecap="round" />
                         <!-- Handle Grip (Visual) -->
                         <rect x="-6" y="40" width="12" height="20" rx="3" fill="#333" />
                         
                         <!-- The Ring (Metal Circle) -->
                         <!-- r=15 -->
                         <circle id="player-ring" cx="0" cy="0" r="15" fill="transparent" stroke="#5c452d" stroke-width="4" />
                         
                         <!-- Touch Hit Area (Invisible, larger than handle for easy grabbing) -->
                         <rect x="-30" y="0" width="60" height="80" fill="transparent" />
                    </g>
                    
                    <!-- Collision Marker (Shows where user hit) -->
                    <circle id="collision-marker" cx="0" cy="0" r="4" fill="red" class="hidden" />
                </svg>

                <!-- Progress Text -->
                <div class="absolute top-4 right-4 bg-wood-100 px-3 py-1 rounded-full text-wood-700 font-mono text-sm border border-wood-200">
                    <span id="game-progress">0</span>%
                </div>
            </div>
            
            <!-- Instruction Text -->
            <div class="mt-4 text-center text-wood-500 text-sm font-bold tracking-wider animate-pulse">
                ğŸ‘‡ æ‹–æ›³é»‘è‰²æ‰‹æŸ„ ä¿æŒåœ“ç’°ä¸ç¢°ç·š
            </div>
        </div>

        <!-- Countdown Overlay -->
        <div id="countdown-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-wood-900/40 backdrop-blur-sm">
            <div id="countdown-val" class="text-9xl font-black text-white drop-shadow-lg animate-ping">3</div>
        </div>
    </div>

    <!-- === RESULT MODAL === -->
    <div id="result-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-wood-900/60 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 text-center relative">
            <div class="text-7xl mb-4">âš¡</div>
            <div class="mb-4">
                <p class="text-wood-600 mb-1 font-bold tracking-wider text-lg">çµæœ</p>
                <p class="text-3xl font-black text-wood-900 tracking-wide">
                    å®Œæˆ <span id="res-percent" class="text-nature-dark">0</span>% è·¯å¾‘
                </p>
            </div>

            <div class="bg-wood-50 p-4 rounded-xl border-2 border-wood-200 mb-4">
                <h3 id="res-msg" class="text-2xl font-bold text-nature-dark mb-2 tracking-wider"></h3>
                <p id="res-submsg" class="text-wood-700 text-base mb-3 font-medium tracking-wide"></p>
                <div class="flex justify-center items-center gap-1 text-wood-400 text-base font-bold bg-white py-2 rounded-lg border border-wood-100">
                    <span>å¾—åˆ†ï¼š</span>
                    <span id="res-score" class="text-3xl text-wood-800">0</span>
                    <span>åˆ†</span>
                </div>
            </div>

            <div class="text-left mb-6">
                <h4 class="text-base font-bold text-wood-500 mb-2 border-b border-wood-100 pb-1 tracking-wider">ğŸ… è¨ˆåˆ†æ–¹å¼</h4>
                <div class="space-y-2 text-sm text-wood-700 tracking-wide">
                    <div class="flex justify-between items-center whitespace-nowrap gap-2">
                        <span class="font-bold text-nature-dark">å®Œæˆ 70ï½100% è·¯å¾‘</span>
                        <span class="font-bold">3åˆ†</span>
                        <span class="text-right flex-1 text-wood-500 overflow-hidden text-ellipsis">è„¾èƒƒå¼·å¥ï¼Œå‹•ä½œéˆå·§</span>
                    </div>
                    <div class="flex justify-between items-center whitespace-nowrap gap-2">
                        <span class="font-bold text-nature-dark">å®Œæˆ 35ï½69% è·¯å¾‘</span>
                        <span class="font-bold">2åˆ†</span>
                        <span class="text-right flex-1 text-wood-500 overflow-hidden text-ellipsis">è„¾èƒƒä¸éŒ¯ï¼Œç¯€å¥ç©©ç•¶</span>
                    </div>
                    <div class="flex justify-between items-center whitespace-nowrap gap-2">
                        <span class="font-bold text-nature-dark">å®Œæˆ 0ï½34% è·¯å¾‘</span>
                        <span class="font-bold">1åˆ†</span>
                        <span class="text-right flex-1 text-wood-500 overflow-hidden text-ellipsis">è„¾èƒƒè­¦å‘Šï¼Œéœ€å¤šèª¿é¤Š</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <button id="btn-result-home" class="flex-1 font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 bg-wood-200 hover:bg-wood-300 text-wood-800 px-4 py-2 text-lg tracking-widest">
                    å›åˆ°é–‹å§‹
                </button>
                <button id="btn-result-restart" class="flex-1 font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 bg-nature-dark hover:bg-green-800 text-white shadow-green-200 px-4 py-2 text-lg tracking-widest">
                    å†ç©ä¸€æ¬¡
                </button>
            </div>
        </div>
    </div>

    <!-- === RULES MODAL === -->
    <div id="rules-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-wood-900/60 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 relative">
            <button id="btn-close-rules" class="absolute top-4 right-4 text-wood-400 hover:text-wood-700 transition-colors p-2 rounded-full hover:bg-wood-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <p class="text-wood-700 mb-2 font-bold text-center tracking-wider text-lg">
                è„¾ä¸»è‚Œè‚‰ï¼Œæ°£è¡€å……ç›ˆå‰‡å‹•ä½œéˆå·§
            </p>
            <p class="text-base text-wood-600 mb-6 leading-relaxed text-center font-medium tracking-wide">
                åœŸè¡Œå°æ‡‰è‡Ÿè…‘ç‚ºè„¾èˆ‡èƒƒï¼Œèˆ‡æ¶ˆåŒ–ã€è‚Œè‚‰å‹•ä½œçš„ç²¾å·§æœ‰é—œã€‚
            </p>
            <h3 class="text-2xl font-bold text-center text-wood-800 mb-4 border-b border-wood-100 pb-3 tracking-widest">
                ğŸ“œ éŠæˆ²è¦å‰‡
            </h3>
            <ul class="space-y-4 text-wood-800 font-medium tracking-wide">
                <li class="flex gap-2 text-base">
                    <span class="font-bold text-nature-dark">â‘ </span>
                    <span>æ‹–æ›³ä¸‹æ–¹æ‰‹æŸ„ï¼Œæ§åˆ¶é‡‘å±¬ç’°æ²¿ç·šå‰é€²</span>
                </li>
                <li class="flex gap-2 text-base">
                    <span class="font-bold text-nature-dark">â‘¡</span>
                    <span>é‡‘å±¬ç’°ä¸å¯è§¸ç¢°è»Œé“ï¼Œå¦å‰‡éŠæˆ²çµæŸ</span>
                </li>
                <li class="flex gap-2 text-base">
                    <span class="font-bold text-nature-dark">â‘¢</span>
                    <span>é™æ™‚30ç§’ï¼Œä¾å‰é€²è·é›¢è¨ˆåˆ†</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- === LOGIC SCRIPT === -->
    <script>
        // --- Constants & Config ---
        const PLAYER_RADIUS = 15; // Ring Radius
        const WIRE_THICKNESS = 6; // Visual wire thickness
        const TOLERANCE_PX = 4;   // Extra forgiveness
        // Collision distance threshold: If CenterDist > (Radius - WireHalf - Tolerance)
        // e.g. 15 - 3 - 4 = 8px deviation allowed.
        const SAFE_DISTANCE = PLAYER_RADIUS - (WIRE_THICKNESS / 2) - TOLERANCE_PX;
        
        // Handle offset: The distance from the Ring Center to where the user likely touches the handle
        // This ensures the ring is above the finger.
        const HANDLE_TOUCH_OFFSET_Y = 50; 

        const PATH_RESOLUTION = 1000;
        
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultModal = document.getElementById('result-modal');
        const rulesModal = document.getElementById('rules-modal');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownValEl = document.getElementById('countdown-val');
        
        const gameSvg = document.getElementById('game-svg');
        const trackPath = document.getElementById('track-path');
        const playerGroup = document.getElementById('player-group');
        const playerRing = document.getElementById('player-ring');
        const collisionMarker = document.getElementById('collision-marker');
        
        const gameProgressEl = document.getElementById('game-progress');
        const timerValEl = document.getElementById('timer-val');
        const timerDisplayEl = document.getElementById('timer-display');

        // Result Elements
        const resPercent = document.getElementById('res-percent');
        const resScore = document.getElementById('res-score');
        const resMsg = document.getElementById('res-msg');
        const resSubMsg = document.getElementById('res-submsg');

        // --- Game State ---
        let gameState = 'START'; // START, COUNTDOWN, PLAYING, FINISHED
        let pathPoints = [];
        let playerProgress = 0; // 0 to 100
        let isDragging = false;
        let timeLeft = 30;
        let timerInterval = null;
        let startPoint = {x: 0, y: 0};
        
        // --- Initialization ---
        function initPath() {
            const len = trackPath.getTotalLength();
            pathPoints = [];
            for (let i = 0; i <= PATH_RESOLUTION; i++) {
                const pt = trackPath.getPointAtLength((i / PATH_RESOLUTION) * len);
                pathPoints.push({ x: pt.x, y: pt.y });
            }
            startPoint = pathPoints[0];
            // Initialize player position to start
            updatePlayerPos(startPoint.x, startPoint.y);
        }

        function updatePlayerPos(x, y) {
            // Move the entire group (Ring + Handle)
            playerGroup.setAttribute('transform', `translate(${x}, ${y})`);
        }

        function switchScreen(screenName) {
            startScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            resultModal.classList.add('hidden');
            rulesModal.classList.add('hidden');

            if (screenName === 'START') startScreen.classList.remove('hidden');
            if (screenName === 'GAME') gameScreen.classList.remove('hidden');
            if (screenName === 'RESULT') {
                gameScreen.classList.remove('hidden'); // Show result over game
                resultModal.classList.remove('hidden');
            }
            if (screenName === 'RULES') {
                gameScreen.classList.remove('hidden'); // Show rules over game
                rulesModal.classList.remove('hidden');
            }
        }

        // --- Game Logic ---

        function startGameSequence() {
            switchScreen('GAME');
            gameState = 'COUNTDOWN';
            timeLeft = 30;
            playerProgress = 0;
            isDragging = false;
            collisionMarker.classList.add('hidden');
            playerRing.setAttribute('stroke', '#5c452d'); // Reset color
            updateUI();
            
            // Reset player to start
            updatePlayerPos(startPoint.x, startPoint.y);

            // Countdown
            countdownOverlay.classList.remove('hidden');
            let count = 3;
            countdownValEl.textContent = count;
            
            const countInt = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownValEl.textContent = count;
                } else {
                    clearInterval(countInt);
                    countdownOverlay.classList.add('hidden');
                    gameState = 'PLAYING';
                    startTimer();
                }
            }, 1000);
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerValEl.textContent = timeLeft;
            timerDisplayEl.classList.remove('text-red-600', 'animate-pulse');
            timerDisplayEl.classList.add('text-wood-900');

            timerInterval = setInterval(() => {
                timeLeft--;
                updateUI();
                if (timeLeft <= 5) {
                    timerDisplayEl.classList.remove('text-wood-900');
                    timerDisplayEl.classList.add('text-red-600', 'animate-pulse');
                }
                if (timeLeft <= 0) {
                    endGame(true); // Time up
                }
            }, 1000);
        }

        function updateUI() {
            timerValEl.textContent = timeLeft;
            gameProgressEl.textContent = Math.round(playerProgress);
        }

        function endGame(timeUp) {
            clearInterval(timerInterval);
            gameState = 'FINISHED';
            isDragging = false;
            showResult();
        }

        function showResult() {
            const pct = Math.round(playerProgress);
            resPercent.textContent = pct;
            
            let score, msg, sub;
            if (pct >= 70) {
                score = 3;
                msg = "è„¾èƒƒå¼·å¥ï¼Œå‹•ä½œéˆå·§";
                sub = "æ‰‹éƒ¨æ§åˆ¶éå¸¸ç²¾ç´°ï¼Œè¡¨ç¾äº®çœ¼ã€‚";
            } else if (pct >= 35) {
                score = 2;
                msg = "è„¾èƒƒä¸éŒ¯ï¼Œç¯€å¥ç©©ç•¶";
                sub = "ä½ çš„ç²¾ç´°åº¦ä¸éŒ¯ï¼Œå†å¤šä¸€é»è€å¿ƒã€‚";
            } else {
                score = 1;
                msg = "è„¾èƒƒè­¦å‘Šï¼Œéœ€å¤šèª¿é¤Š";
                sub = "æ·±å‘¼å¸ï¼Œæ”¾æ…¢ä¸€é»ï¼Œä¸‹ä¸€æ¬¡æœƒæ›´ç²¾æº–ã€‚";
            }
            
            resScore.textContent = score;
            resMsg.textContent = msg;
            resSubMsg.textContent = sub;
            
            switchScreen('RESULT');
        }

        // --- Interaction Logic ---
        
        function getSVGCoordinates(evt) {
            const pt = gameSvg.createSVGPoint();
            // Handle touch or mouse
            if (evt.touches && evt.touches.length) {
                pt.x = evt.touches[0].clientX;
                pt.y = evt.touches[0].clientY;
            } else {
                pt.x = evt.clientX;
                pt.y = evt.clientY;
            }
            return pt.matrixTransform(gameSvg.getScreenCTM().inverse());
        }

        function handlePointerDown(e) {
            if (gameState !== 'PLAYING') return;
            const pos = getSVGCoordinates(e);
            
            // Get current Player Center Position from transform
            const transform = playerGroup.getAttribute('transform');
            const matches = transform.match(/translate\(([^,]+),\s*([^)]+)\)/);
            if (!matches) return;
            
            const currentX = parseFloat(matches[1]);
            const currentY = parseFloat(matches[2]);

            // Hit testing: Check if user clicked near the handle (below the ring)
            // Handle is approx at (currentX, currentY + 30)
            const handleX = currentX;
            const handleY = currentY + 40; // Approx handle center
            
            const dist = Math.hypot(pos.x - handleX, pos.y - handleY);
            
            // Large pickup radius for the handle (60px)
            if (dist < 60) {
                isDragging = true;
                // Snap to handle center logic could go here, but smooth drag is better
                handlePointerMove(e);
            }
        }

        function handlePointerMove(e) {
            if (gameState !== 'PLAYING' || !isDragging) return;
            
            const cursor = getSVGCoordinates(e);
            
            // Apply Offset: The RING (player) should be above the cursor (handle position)
            // This prevents the finger from covering the ring
            const targetRingX = cursor.x;
            const targetRingY = cursor.y - HANDLE_TOUCH_OFFSET_Y;

            // 1. Move Player Group to new location immediately (Responsive UI)
            updatePlayerPos(targetRingX, targetRingY);

            // 2. Check Collision against Path
            // Find nearest point on path to the RING CENTER
            const totalPoints = pathPoints.length;
            const currentIdx = Math.floor((playerProgress / 100) * totalPoints);
            const searchWindow = 100; 
            
            let bestDist = Infinity;
            let bestIdx = currentIdx;
            let nearestPoint = null;

            // Search optimization: Look around current progress
            const startSearch = Math.max(0, currentIdx - 20);
            const endSearch = Math.min(totalPoints - 1, currentIdx + searchWindow);

            for (let i = startSearch; i <= endSearch; i++) {
                const pt = pathPoints[i];
                const d = Math.hypot(targetRingX - pt.x, targetRingY - pt.y);
                if (d < bestDist) {
                    bestDist = d;
                    bestIdx = i;
                    nearestPoint = pt;
                }
            }

            // 3. Collision Logic: Buzz Wire Mode
            // Distance is from Ring Center to Wire Center.
            // Ring Radius = 15, Wire Thickness = 6.
            // Inner gap = 15 - 3 = 12.
            // Wire radius = 3.
            // Collision if Ring Inner Edge hits Wire Outer Edge.
            // i.e., Distance > (RingRadius - WireThickness/2)
            // With Tolerance: Distance > (15 - 3 + tolerance) -> Collision
            
            // Actually, prompt asked for stricter: Distance > (r + tolerance) implies OUT.
            // But physics wise: if distance > (RingRadius - WireRadius), we hit.
            // Let's use SAFE_DISTANCE constant.
            
            if (bestDist > SAFE_DISTANCE + TOLERANCE_PX) {
                // COLLISION!
                collisionMarker.setAttribute('cx', nearestPoint.x);
                collisionMarker.setAttribute('cy', nearestPoint.y);
                collisionMarker.classList.remove('hidden');
                playerRing.setAttribute('stroke', '#ff0000'); // Red ring
                endGame(false); 
                return;
            }

            // 4. Update Progress
            // Only update if moved forward
            const newProgress = (bestIdx / totalPoints) * 100;
            if (newProgress > playerProgress) {
                playerProgress = newProgress;
                gameProgressEl.textContent = Math.round(playerProgress);
            }

            // 5. Win Check
            if (playerProgress >= 98) {
                playerProgress = 100;
                endGame(false); // Finished
            }
        }

        function handlePointerUp(e) {
            isDragging = false;
        }

        // --- Event Listeners ---
        document.getElementById('btn-start-game').addEventListener('click', startGameSequence);
        document.getElementById('btn-restart').addEventListener('click', startGameSequence);
        document.getElementById('btn-result-restart').addEventListener('click', startGameSequence);
        document.getElementById('btn-result-home').addEventListener('click', () => switchScreen('START'));
        
        document.getElementById('btn-show-rules').addEventListener('click', () => {
            if (gameState === 'PLAYING') isDragging = false; 
            rulesModal.classList.remove('hidden');
        });
        document.getElementById('btn-close-rules').addEventListener('click', () => rulesModal.classList.add('hidden'));

        // Pointer Events for SVG
        gameSvg.addEventListener('mousedown', handlePointerDown);
        gameSvg.addEventListener('mousemove', handlePointerMove);
        window.addEventListener('mouseup', handlePointerUp);

        gameSvg.addEventListener('touchstart', handlePointerDown, { passive: false });
        gameSvg.addEventListener('touchmove', (e) => { e.preventDefault(); handlePointerMove(e); }, { passive: false });
        window.addEventListener('touchend', handlePointerUp);

        // --- Init ---
        window.onload = () => {
            initPath();
            switchScreen('START');
        };

    </script>
</body>
</html>